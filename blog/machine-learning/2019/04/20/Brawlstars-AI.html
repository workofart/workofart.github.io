<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.5.0 -->
<title>BrawlStars AI Series (Part 1) | Henry’s Blog</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="BrawlStars AI Series (Part 1)" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Brawlstars: https://supercell.com/en/games/brawlstars/" />
<meta property="og:description" content="Brawlstars: https://supercell.com/en/games/brawlstars/" />
<link rel="canonical" href="http://henrypan.com/blog/machine-learning/2019/04/20/Brawlstars-AI.html" />
<meta property="og:url" content="http://henrypan.com/blog/machine-learning/2019/04/20/Brawlstars-AI.html" />
<meta property="og:site_name" content="Henry’s Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-04-20T01:00:00-04:00" />
<script type="application/ld+json">
{"url":"http://henrypan.com/blog/machine-learning/2019/04/20/Brawlstars-AI.html","headline":"BrawlStars AI Series (Part 1)","datePublished":"2019-04-20T01:00:00-04:00","dateModified":"2019-04-20T01:00:00-04:00","description":"Brawlstars: https://supercell.com/en/games/brawlstars/","mainEntityOfPage":{"@type":"WebPage","@id":"http://henrypan.com/blog/machine-learning/2019/04/20/Brawlstars-AI.html"},"@type":"BlogPosting","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/blog/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://henrypan.com/blog/feed.xml" title="Henry's Blog" /></head>
<body><header class="site-header" role="banner">
    <div class="wrapper"><a class="site-title" rel="author" href="/blog/">Henry&#39;s Blog</a><nav class="site-nav">
          <input type="checkbox" id="nav-trigger" class="nav-trigger" />
          <label for="nav-trigger">
            <span class="menu-icon">
              <svg viewBox="0 0 18 15" width="18px" height="15px">
                <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
              </svg>
            </span>
          </label>
  
          <div class="trigger">
            <a class="page-link" href="http://henrypan.com">Homepage</a>
            <!---->
          </div>
        </nav></div>
  </header>
  <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">BrawlStars AI Series (Part 1)</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2019-04-20T01:00:00-04:00" itemprop="datePublished">Apr 20, 2019
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>Brawlstars: <a href="https://supercell.com/en/games/brawlstars/">https://supercell.com/en/games/brawlstars/</a></p>

<h2 id="1-motivation">1. Motivation</h2>
<p>I’ve personally being playing Brawlstars for over 3 months, and it’s a simple game to start considering the limited key combinations that it has. However, it’s fairly hard to master, considering the different mechanics each character has and the different maps in which each character’s play style can be affected by.</p>

<h2 id="2-goals">2. Goals</h2>
<p>For this project, I want to train an agent that will be able to play Brawlstars decently (be able to consistently beat built-in AI, and be able to play in Player-vs-Player (PVP) games “like” a human player. During the process, my personal goal is to brush up on topics in computer vision and deep learning.</p>

<h2 id="3-starting-point">3. Starting Point</h2>
<p>As for the game, I will start with the “Bounty” game mode and the “Temple Ruins” map as the fixed map, with “Shelly” being the character to train on.</p>

<p><strong>Map</strong></p>

<p><img src="https://vignette.wikia.nocookie.net/brawlstars/images/3/3e/Temple_Ruins-Map.png/revision/latest/scale-to-width-down/310?cb=20190714193752" alt="Map" width="180" /></p>

<p><strong>Character</strong></p>

<p>More info: <a href="https://brawlstars.fandom.com/wiki/Shelly">https://brawlstars.fandom.com/wiki/Shelly</a></p>

<p><img src="https://vignette.wikia.nocookie.net/brawlstars/images/5/5e/Shelly_Skin-Default.png/revision/latest?cb=20191220032258" alt="Shelly" width="100" /></p>

<p><strong>Game Mode</strong></p>

<p>Bounty: <a href="https://brawlstars.fandom.com/wiki/Bounty">https://brawlstars.fandom.com/wiki/Bounty</a></p>

<p><strong>Considerations</strong></p>

<ol>
  <li>
    <p>Ultimately, I will want to explore Reinforcement learning (RL), and one of the hardest things is reward definition. (Refer to my post about defining reward in stock trading using RL). The “Bounty” game mode allows for straight-forward reward definition by the number of stars each player gains by killing the opposing players.</p>
  </li>
  <li>
    <p>“Shelly” has a simple set of attack mechanics. Her normal attack is short-to-medium range, and her super attack is the same range with more damage.</p>
  </li>
  <li>
    <p>Using a fixed map allows me to eliminate a lot of the variation in agent performance due to map mechanics or other factors that is derived from the map.</p>
  </li>
</ol>

<h2 id="3-related-work">3. Related Work</h2>
<p><a href="https://github.com/ChintanTrivedi/DeepGamingAI_FIFA">FIFA AI</a> For inspiring me to try out LSTM for action determination in supervised learning.</p>

<p><a href="https://github.com/Sentdex/pygta5">PyGTA5</a> For the initial direction with regards to perception and supervised learning training data generation.</p>

<h2 id="4-project-focusscope">4. Project Focus/Scope</h2>
<p>In the first part of this series of projects, I will be exploring the possibility of using supervised learning to train an agent to play Brawlstars. In the process, I will evaluate different feature extractors and identify other areas of improvements.</p>

<p>The second part of the project is to use reinforcement learning to let the agent play Brawlstars on its own and learn from it’s own mistakes. In this process, I will evaluate various RL techniques to improvement the agent’s decision-making abilities.</p>

<h2 id="5-showcase">5. Showcase</h2>
<p><a href="https://github.com/workofart/brawlstars-ai">Code &amp; Gameplay Snapshot</a></p>

<h2 id="6-supervised-learning">6. Supervised Learning</h2>

<h3 id="61-creating-training-data">6.1 Creating training data</h3>
<p>As the name suggests, supervised learning requires training data with labeled ground truth. As for this project, I will be the person creating the training data by playing the game. The <em>screen information</em> and my <em>key presses</em> will be recorded into training data, which will be fed into the agent during the training process.</p>

<h3 id="62-features">6.2 Features</h3>

<h4 id="621-raw-pixels-as-features">6.2.1 Raw Pixels as Features</h4>
<p>Feeding in raw pixels doesn’t yield too good of a result, because it’s difficult to make sense of individual pixels and translate them into concrete meaning. For example, it’s hard for the agent to infer from raw pixels which set of pixels corresponds to the its own player, allies or enemies.</p>

<p>For my training instance, I used 1 hour of game play data played only on the fixed map “Temple Ruins”.</p>

<h4 id="622-using-mobilenet-as-the-feature-extractor">6.2.2 Using MobileNet as the feature extractor</h4>

<p>After seeing the performance of raw pixels, I decided to try out some feature extractors that could help with the performance of the agent for Supervised Learning. I chose Mobilenet as the feature extractor for its balance between high accuracy and fast speed.</p>

<p>For my training instance, I used 1 hour of data played only on the fixed map “Temple Ruins”.</p>

<h3 id="63-action-determination">6.3 Action Determination</h3>

<h4 id="631-alexnet-convolutional-neural-network">6.3.1 AlexNet (Convolutional Neural Network)</h4>
<p><strong>Motivation:</strong> As a starting point, AlexNet is fairly robust for image feature extraction and classification.</p>

<p><em>Input</em>: Raw Pixels</p>

<p><em>Output</em>: A one-hot array of 6 elements. Representing (left, right, forward, backward, attack, superattack) Basically, the neural network will try to classify “snapshot” of the game screen into one of 6 actions.</p>

<p><img src="https://cdn-images-1.medium.com/max/1600/0*xPOQ3btZ9rQO23LK.png" alt="AlexNet" /></p>

<p>Paper Reference: <em>https://papers.nips.cc/paper/4824-imagenet-classification-with-deep-convolutional-neural-networks.pdf</em></p>

<h4 id="632-long-short-term-memory">6.3.2 Long short-term memory</h4>
<p><strong>Motivation:</strong> Because this is a game with animation composed of frames of game screen. It is intuitive to think that a sequence of frames will provide more information than one snapshot of the game screen. This is the main motivation for choosing LSTM. The intuition behind separating into 2 LSTMs is because the movement actions and attack actions are not necessarily mutually exclusive—one can, and ought to, move and attack at the same time.</p>

<p><em>Input</em>: Features extracted by MobileNet from after the last convolutional layer and right before the softmax.</p>

<p><em>Output</em>: A one-hot array representing the actions to take</p>

<p><strong>LSTM1</strong> - A one-hot array of 5 elements. Representing (left, right, forward, backward, no-op)</p>

<p><strong>LSTM2</strong> - A one-hot array of 3 elements. Representing (attack, superattack, no-op)</p>

<p><em>Note that each set of actions includes no-op (no action) compared to the AlexNet approach.</em></p>

<p><strong><a href="https://github.com/workofart/brawlstars-ai/blob/master/net/lstm.py">NN Architecture</a></strong></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Input - LSTM Layer 1 - Dropout - LSTM Layer 2 - Dropout
- Fully Connected Layer - Softmax Activation
</code></pre></div></div>

<p>Training blew up my home desktop due to the amount of memory the feature space occupys at the peak. I had to use Google Cloud’s VM with 32GB of ram to train this.</p>

<h2 id="7-challenges">7. Challenges</h2>

<h3 id="71-data">7.1 Data</h3>

<p>The challenge with supervised learning is always with data gathering. In this case, I can’t gather a huge amount of gameplay data for the agent to be trained to play well. Also, the generalization ability of supervised learning is questionable. Does the agent play well on other maps? Other characters? I believe incorporating reinforcement learning into the equation will allow the agent to develop a more robust and general strategy for playing this game. Also, by using RL, I personally wouldn’t need to “waste time” playing the game to generate training data.</p>

<h3 id="72-features">7.2 Features</h3>

<p>Since there was no game “hacking” involved or game data available for the agent to use, getting the features to be passed into the agent for supervised learning was challenging. I had to visualize the CNN intermediary layers to understand if the CNN was useful in detecting and classifying elements of the game. This was important because even if the agent’s decision-making abilities (planning) were superb, giving misleading information (bad perception) might still lead to chaos.</p>

<p><strong>Snapshot of Intermediate CNN Layers</strong></p>

<p>This is visualized using the second-last <strong>(CONV-5-1)</strong> block (out of 5 blocks) of the <a href="https://arxiv.org/abs/1409.1556">Very Deep Convolutional Networks for Large-Scale Image Recognition (VGG)</a> architecture.
<img src="https://neurohive.io/wp-content/uploads/2018/11/vgg16.png" alt="VGG16" />
Reference: https://neurohive.io/en/popular-networks/vgg16/</p>

<p><img src="https://github.com/workofart/brawlstars-ai/raw/master/vgg_block5_conv1_18x18.png" alt="CNNVIZ" /></p>

<h2 id="8-statistics-and-performance">8. Statistics and Performance</h2>

<p><strong>The input screen dimension:</strong> 1280 x 715 (cut off some pixels from the title bar)</p>

<p><strong>Supervised Learning</strong></p>

<ul>
  <li>Trained on Raw Pixels fed into Alexnet for decision output with the following hyperparameters:
    <ul>
      <li>EPOCHS=500</li>
      <li>Learning Rate=3e-5</li>
      <li>Resize_Width=80</li>
      <li>Resize_Height=60</li>
      <li>Batch size=12</li>
    </ul>
  </li>
  <li>Trained on MobileNet extracted features fed into 2 LSTMs for decision output with the following hyperparameters:
    <ul>
      <li>Mobilenet</li>
      <li>Learning Rate=3e-5</li>
      <li>Batch size=8</li>
    </ul>
  </li>
</ul>

<p>The best way to evaluate performance in this game is by keeping track of the average number of stars the player possess throughout the game. This is a high-level reward/goal because it encompasses short-term goals of killing the oponent and gaining an additional star each time and a long-term goal of not dying and resetting the player’s stars to 2.</p>

<p><strong>Human Benchmark (Measured by myself):</strong>
For the given setting, I can, on average, possess 5 stars throughout the game. With aggresive playstyle taking the initial 30 seconds, and conservative playstyle dominating the last 30 seconds, to preserve the 7 max stars on the player.</p>

<p><strong>Agent Performance:</strong>
For the given setting, in the supervised learning approach, the results weren’t impressive. The agent does avoid running into the wall, but attacks randomly at no target.</p>

<h2 id="9-error-analysis--future-steps">9. Error Analysis + Future Steps</h2>

<p>I wasn’t surprised that supervised learning in a dynamic multi-agent environment would not go well. Unless I have near infinite amount of training data, I wouldn’t be able to train a decent agent.</p>

<p>Next, I will attempt to tackle this problem from a more fundamental level, starting from perception. Currently, I simply “dump” the pixels as input to a feature extractor, and hope that it will be able to transfer-learn some useful features.</p>

<p>Then, I am going to apply reinforcement learning on this problem to tackle the planning part of it. I will be framing the environment, constructing the agent’s brain, and designing rewards.</p>

<p>If you’re interested, please check my next post <a href="http://www.henrypan.com/blog/reinforcement-learning/2019/04/25/Brawlstars-RL.html">here</a>. Thanks!</p>

<p>- Henry</p>

  </div><a class="u-url" href="/blog/machine-learning/2019/04/20/Brawlstars-AI.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/blog/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Henry&#39;s Blog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Henry&#39;s Blog</li><li><a class="u-email" href="mailto:hanxiangp@gmail.com">hanxiangp@gmail.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/workofart"><svg class="svg-icon"><use xlink:href="/blog/assets/minima-social-icons.svg#github"></use></svg> <span class="username">workofart</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>My learning notes, research, projects and musings.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
